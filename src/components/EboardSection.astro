---
// Eboard Section - 3D classroom background
---

<div class="eboard-section" data-eboard-section>
  <canvas class="eboard-section__canvas" data-eboard-canvas></canvas>
</div>

<script>
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
  import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

  // Debug mode - set to true to enable orbit controls for testing
  const DEBUG_MODE = true;

  function initEboardScene() {
    const canvas = document.querySelector('[data-eboard-canvas]') as HTMLCanvasElement;
    if (!canvas) return;

    console.log('[Eboard] Initializing 3D scene...');

    // Scene setup - set dark background to prevent glitching
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0a);

    // Camera
    const camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 1.5, 4);
    camera.lookAt(0, 1, 0);

    // Renderer - configured to preserve original model colors and lighting
    const renderer = new THREE.WebGLRenderer({
      canvas,
      antialias: true,
      alpha: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    // Use neutral tone mapping to preserve original colors
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;

    // Important: Set output color space for correct colors
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    // Debug controls for camera movement
    let controls: OrbitControls | null = null;
    if (DEBUG_MODE) {
      controls = new OrbitControls(camera, canvas);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.target.set(0, 1, 0);
      controls.update();

      // Enable pointer events for debug controls
      const section = document.querySelector('[data-eboard-section]') as HTMLElement;
      if (section) section.style.pointerEvents = 'auto';

      console.log('[Eboard] Debug mode enabled - use mouse to orbit camera');
    }

    // Load the classroom model
    const loader = new GLTFLoader();
    console.log('[Eboard] Loading classroom model from /models/classroom.glb');

    loader.load(
      '/models/classroom.glb',
      (gltf) => {
        console.log('[Eboard] Model loaded successfully!');
        console.log('[Eboard] Scene children:', gltf.scene.children.length);

        const model = gltf.scene;
        model.scale.set(1, 1, 1);
        model.position.set(0, 0, 0);

        // Log model info for debugging
        let meshCount = 0;
        let lightCount = 0;

        model.traverse((child) => {
          if ((child as THREE.Mesh).isMesh) {
            meshCount++;
            const mesh = child as THREE.Mesh;

            // Enable shadows
            mesh.castShadow = true;
            mesh.receiveShadow = true;

            // Log material info
            if (DEBUG_MODE && meshCount <= 5) {
              console.log(`[Eboard] Mesh: ${child.name}`, {
                material: mesh.material,
                geometry: mesh.geometry
              });
            }
          }

          // Check for lights embedded in the model
          if ((child as THREE.Light).isLight) {
            lightCount++;
            console.log(`[Eboard] Found embedded light: ${child.name}`, child);
          }
        });

        console.log(`[Eboard] Total meshes: ${meshCount}, embedded lights: ${lightCount}`);

        // Add model to scene
        scene.add(model);

        // If model has its own environment/lighting, use it
        if (gltf.scene.environment) {
          scene.environment = gltf.scene.environment;
          console.log('[Eboard] Using model environment map');
        }

        // Calculate bounding box to help position camera
        const box = new THREE.Box3().setFromObject(model);
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());

        console.log('[Eboard] Model bounds:', { size, center });

        // Update camera target if using orbit controls
        if (controls) {
          controls.target.copy(center);
          controls.update();
        }
      },
      (progress) => {
        const percent = progress.total > 0
          ? Math.round((progress.loaded / progress.total) * 100)
          : 'unknown';
        console.log(`[Eboard] Loading: ${percent}%`);
      },
      (error) => {
        console.error('[Eboard] Error loading classroom model:', error);
      }
    );

    // Add basic lighting to illuminate the model
    // (only if model doesn't have its own lighting)
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
    mainLight.position.set(5, 10, 7);
    mainLight.castShadow = true;
    mainLight.shadow.mapSize.width = 2048;
    mainLight.shadow.mapSize.height = 2048;
    mainLight.shadow.camera.near = 0.1;
    mainLight.shadow.camera.far = 50;
    scene.add(mainLight);

    // Fill light from opposite side
    const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
    fillLight.position.set(-5, 5, -5);
    scene.add(fillLight);

    // Optional: Add subtle camera movement (disabled in debug mode)
    let time = 0;
    const initialCameraPos = camera.position.clone();

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);

      if (DEBUG_MODE && controls) {
        controls.update();
      } else {
        // Subtle camera sway when not in debug mode
        time += 0.005;
        camera.position.x = initialCameraPos.x + Math.sin(time) * 0.1;
        camera.position.y = initialCameraPos.y + Math.cos(time * 0.7) * 0.05;
        camera.lookAt(0, 1, 0);
      }

      renderer.render(scene, camera);
    }
    animate();

    // Handle resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    console.log('[Eboard] Scene initialized');
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEboardScene);
  } else {
    initEboardScene();
  }
</script>

<style>
  .eboard-section {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 6;
    pointer-events: none;
    overflow: hidden;
    /* Start hidden - scroll animation will show it */
    visibility: hidden;
    opacity: 0;
  }

  .eboard-section__canvas {
    width: 100%;
    height: 100%;
    display: block;
  }
</style>
