---
import CloseIcon from '../icons/CloseIcon.astro';

interface NavItem {
  label: string;
  href: string;
  children?: { label: string; href: string }[];
}

const navItems: NavItem[] = [
  { label: 'Home', href: '/' },
  { label: 'About', href: '#about-section' },
  { label: 'Meetings', href: '#meetings-section' },
  { label: 'Activities', href: '#activities-section' },
  { label: 'Partners', href: '#partners-section' },
  {
    label: 'Subgroups',
    href: '#subgroups-section',
    children: [
      { label: 'Animusic', href: '#subgroup-animusic' },
      { label: 'Cosplay', href: '#subgroup-cosplay' },
      { label: 'Old Anime', href: '#subgroup-oldanime' },
      { label: 'Book Club', href: '#subgroup-bookclub' },
      { label: 'Rainbow', href: '#subgroup-rainbow' },
    ]
  },
  {
    label: 'Events',
    href: '#',
    children: [
      { label: 'TerpCon 2026', href: '/terpcon' },
      { label: 'Kamecon', href: '/kamecon' },
      { label: 'Maid Cafe', href: '/maidcafe' },
    ]
  },
];
---

<nav
  class="navigation-menu"
  id="navigation-menu"
  aria-label="Main navigation"
  data-menu
>
  <div class="navigation-menu__backdrop" data-menu-backdrop></div>

  <div class="navigation-menu__panel" data-menu-panel>
    <div class="navigation-menu__header">
      <div class="navigation-menu__title-wrapper">
        <img src="/images/Icons/chibi.webp" alt="" class="navigation-menu__icon" />
        <span class="navigation-menu__title">Navigation</span>
      </div>
      <button
        class="navigation-menu__close"
        type="button"
        aria-label="Close navigation menu"
        data-menu-close
      >
        <CloseIcon size={24} />
      </button>
    </div>

    <ul class="navigation-menu__list">
      {navItems.map((item, index) => (
        <li class={`navigation-menu__item ${item.children ? 'navigation-menu__item--has-children' : ''}`} style={`--item-index: ${index}`}>
          <a class="navigation-menu__link" href={item.href} data-menu-link>
            <span class="navigation-menu__link-index">
              {String(index + 1).padStart(2, '0')}
            </span>
            <span class="navigation-menu__link-label">{item.label}</span>
            {item.children && (
              <svg class="navigation-menu__chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            )}
          </a>
          {item.children && (
            <ul class="navigation-menu__dropdown">
              {item.children.map((child) => (
                <li class="navigation-menu__dropdown-item">
                  <a class="navigation-menu__dropdown-link" href={child.href} data-menu-link>
                    {child.label}
                  </a>
                </li>
              ))}
            </ul>
          )}
        </li>
      ))}
    </ul>

    <div class="navigation-menu__footer">
      <p class="navigation-menu__footer-text">University of Maryland</p>
    </div>
  </div>
</nav>

<div class="teleport-loader" data-teleport-loader>
  <div class="teleport-loader__content">
    <img src="/images/Icons/chibi.webp" alt="" class="teleport-loader__icon" />
    <div class="teleport-loader__bar">
      <div class="teleport-loader__bar-fill"></div>
    </div>
  </div>
</div>

<style>
  .teleport-loader {
    position: fixed;
    inset: 0;
    z-index: 10000;
    background-color: #0a0a0a;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s ease, visibility 0.15s ease;
  }

  .teleport-loader[data-active="true"] {
    opacity: 1;
    visibility: visible;
  }

  .teleport-loader__content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .teleport-loader__icon {
    width: 56px;
    height: 56px;
    object-fit: contain;
    opacity: 0;
    transform: scale(0.8);
  }

  .teleport-loader[data-active="true"] .teleport-loader__icon {
    animation: iconReveal 0.3s ease forwards;
  }

  @keyframes iconReveal {
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .teleport-loader__bar {
    width: 120px;
    height: 2px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 1px;
    overflow: hidden;
  }

  .teleport-loader__bar-fill {
    height: 100%;
    width: 0;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 1px;
  }

  .teleport-loader[data-active="true"] .teleport-loader__bar-fill {
    animation: barProgress 0.4s ease forwards;
  }

  @keyframes barProgress {
    to { width: 100%; }
  }

  .navigation-menu {
    position: fixed;
    inset: 0;
    z-index: var(--z-navigation);
    pointer-events: none;
    visibility: hidden;
  }

  .navigation-menu[data-open="true"] {
    pointer-events: auto;
    visibility: visible;
  }

  .navigation-menu__backdrop {
    position: absolute;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.8);
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  .navigation-menu[data-open="true"] .navigation-menu__backdrop {
    opacity: 1;
  }

  .navigation-menu__panel {
    position: absolute;
    top: 0;
    left: 0;
    width: min(400px, 90vw);
    height: 100%;
    display: flex;
    flex-direction: column;
    background-color: var(--color-bg-secondary);
    border-right: 1px solid var(--color-border);
    transform: translateX(-100%);
    transition: transform var(--transition-slow);
  }

  .navigation-menu[data-open="true"] .navigation-menu__panel {
    transform: translateX(0);
  }

  .navigation-menu__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-lg) var(--space-xl);
    border-bottom: 1px solid var(--color-border);
  }

  .navigation-menu__title-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .navigation-menu__icon {
    width: 48px;
    height: 48px;
    object-fit: contain;
  }

  .navigation-menu__title {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
  }

  .navigation-menu__close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    color: var(--color-text-secondary);
    transition: color var(--transition-fast);
  }

  .navigation-menu__close:hover {
    color: var(--color-text-primary);
  }

  .navigation-menu__list {
    flex: 1;
    padding: var(--space-xl);
    overflow-y: auto;
  }

  .navigation-menu__item {
    opacity: 0;
    transform: translateX(-20px);
  }

  .navigation-menu[data-open="true"] .navigation-menu__item {
    opacity: 1;
    transform: translateX(0);
    transition: opacity var(--transition-base), transform var(--transition-base);
    transition-delay: calc(var(--item-index) * 50ms + 100ms);
  }

  .navigation-menu__link {
    display: flex;
    align-items: baseline;
    gap: var(--space-lg);
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--color-border);
    transition: border-color var(--transition-fast);
  }

  .navigation-menu__link:hover {
    border-color: var(--color-text-primary);
  }

  .navigation-menu__link-index {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-muted);
    font-variant-numeric: tabular-nums;
  }

  .navigation-menu__link-label {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    transition: color var(--transition-fast);
  }

  .navigation-menu__link:hover .navigation-menu__link-label {
    color: var(--color-text-secondary);
  }

  .navigation-menu__chevron {
    margin-left: auto;
    color: var(--color-text-muted);
    transition: transform var(--transition-fast);
  }

  .navigation-menu__item--has-children:hover .navigation-menu__chevron {
    transform: rotate(180deg);
  }

  .navigation-menu__dropdown {
    max-height: 0;
    overflow: hidden;
    padding-left: 2.5rem;
    transition: max-height 0.3s ease;
  }

  .navigation-menu__item--has-children:hover .navigation-menu__dropdown {
    max-height: 300px;
  }

  .navigation-menu__dropdown-item {
    opacity: 0;
    transform: translateX(-10px);
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .navigation-menu__item--has-children:hover .navigation-menu__dropdown-item {
    opacity: 1;
    transform: translateX(0);
  }

  .navigation-menu__dropdown-item:nth-child(1) { transition-delay: 0.05s; }
  .navigation-menu__dropdown-item:nth-child(2) { transition-delay: 0.1s; }
  .navigation-menu__dropdown-item:nth-child(3) { transition-delay: 0.15s; }
  .navigation-menu__dropdown-item:nth-child(4) { transition-delay: 0.2s; }
  .navigation-menu__dropdown-item:nth-child(5) { transition-delay: 0.25s; }

  .navigation-menu__dropdown-link {
    display: block;
    padding: 0.5rem 0;
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    transition: color var(--transition-fast);
  }

  .navigation-menu__dropdown-link:hover {
    color: var(--color-text-primary);
  }

  .navigation-menu__footer {
    padding: var(--space-xl);
    border-top: 1px solid var(--color-border);
  }

  .navigation-menu__footer-text {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const loader = document.querySelector('[data-teleport-loader]') as HTMLElement;

    const sectionPositions: Record<string, number> = {
      '/': 0,
      '#about-section': 0.05,
      '#meetings-section': 0.12,
      '#activities-section': 0.35,
      '#partners-section': 0.48,
      '#subgroups-section': 0.58,
      '#subgroup-animusic': 0.65,
      '#subgroup-cosplay': 0.73,
      '#subgroup-oldanime': 0.81,
      '#subgroup-bookclub': 0.89,
      '#subgroup-rainbow': 0.96,
    };

    const teleportTo = (position: number) => {
      if (loader) {
        loader.setAttribute('data-active', 'true');
      }

      const menu = document.querySelector('[data-menu]');
      if (menu) {
        menu.setAttribute('data-open', 'false');
        document.body.style.overflow = '';
      }

      setTimeout(() => {
        const docHeight = document.documentElement.scrollHeight;
        const viewportHeight = window.innerHeight;
        const maxScroll = docHeight - viewportHeight;
        const targetScroll = maxScroll * position;

        window.scrollTo(0, targetScroll);

        // @ts-ignore
        if (window.ScrollTrigger) {
          window.ScrollTrigger.update();
          requestAnimationFrame(() => {
            window.ScrollTrigger.update();
          });
        }

        setTimeout(() => {
          if (loader) {
            loader.setAttribute('data-active', 'false');
          }
        }, 400);
      }, 400);
    };

    Object.entries(sectionPositions).forEach(([href, position]) => {
      const links = document.querySelectorAll(`a[href="${href}"]`);

      links.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();

          if (window.location.pathname !== '/') {
            if (href.startsWith('#')) {
              sessionStorage.setItem('teleportTo', String(position));
              window.location.href = '/';
            } else if (href === '/') {
              window.location.href = '/';
            }
            return;
          }

          teleportTo(position);
        });
      });
    });

    const storedPosition = sessionStorage.getItem('teleportTo');
    if (storedPosition && window.location.pathname === '/') {
      sessionStorage.removeItem('teleportTo');
      setTimeout(() => {
        teleportTo(parseFloat(storedPosition));
      }, 100);
    }
  });
</script>
