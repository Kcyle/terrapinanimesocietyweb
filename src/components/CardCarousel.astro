---
interface Props {
  images?: string[];
}

const defaultImages = [
  '/images/Cards/1.webp',
  '/images/Cards/2.webp',
  '/images/Cards/3.webp',
  '/images/Cards/4.webp',
  '/images/Cards/5.webp',
  '/images/Cards/6.webp',
  '/images/Cards/7.webp',
  '/images/Cards/8.webp',
  '/images/Cards/9.webp',
  '/images/Cards/10.webp',
  '/images/Cards/11.webp',
  '/images/Cards/12.webp',
  '/images/Cards/13.webp',
  '/images/Cards/14.webp',
  '/images/Cards/15.webp',
  '/images/Cards/16.webp',
  '/images/Cards/17.webp',
  '/images/Cards/18.webp',
  '/images/Cards/19.webp',
  '/images/Cards/20.webp',
  '/images/Cards/21.webp',
  '/images/Cards/22.webp',
  '/images/Cards/23.webp',
  '/images/Cards/24.webp',
  '/images/Cards/25.webp',
  '/images/Cards/26.webp',
  '/images/Cards/27.webp',
  '/images/Cards/28.webp',
  '/images/Cards/29.webp',
  '/images/Cards/30.webp',
  '/images/Cards/31.webp',
];

const { images = defaultImages } = Astro.props;
const duplicatedImages = [...images, ...images];
---

<div class="card-carousel" data-card-carousel>
  <div class="card-carousel__track" data-carousel-track>
    {duplicatedImages.map((src, index) => (
      <div class="card-carousel__slide" data-carousel-slide>
        <img
          src={src}
          alt={`Anime card ${(index % images.length) + 1}`}
          class="card-carousel__image"
          loading="lazy"
        />
        <div class="card-carousel__overlay">
          <a
            href={src}
            download={`card-${(index % images.length) + 1}`}
            class="card-carousel__download"
            aria-label={`Download card ${(index % images.length) + 1}`}
          >
            <svg class="card-carousel__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            <span>Download</span>
          </a>
        </div>
      </div>
    ))}
  </div>
</div>

<style>
  .card-carousel {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    contain: layout style paint;
  }

  .card-carousel__track {
    display: flex;
    height: 100%;
    gap: 1.33vw;
    animation: scroll 50s linear infinite;
    will-change: transform;
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  /* Pause animation when carousel is not visible */
  .card-carousel.paused .card-carousel__track {
    animation-play-state: paused;
  }

  .card-carousel__slide {
    position: relative;
    flex-shrink: 0;
    /* Fill available height from parent */
    height: 100%;
    aspect-ratio: 2 / 3;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 0.67vw;
    overflow: hidden;
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  .card-carousel__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .card-carousel__overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 1.5rem;
    background: transparent;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
  }

  .card-carousel__slide:hover .card-carousel__overlay {
    opacity: 1;
    pointer-events: auto;
  }

  .card-carousel__download {
    display: flex;
    align-items: center;
    gap: 0.37vh;
    padding: 0.89vh 1vw;
    font-family: 'Inter', sans-serif;
    font-size: 0.67vw;
    font-weight: 600;
    color: #0a0a0a;
    background-color: #ffffff;
    border: 1px solid #ffffff;
    border-radius: 0.42vw;
    text-decoration: none;
    transition: background-color 0.2s ease;
  }

  .card-carousel__download:hover {
    background-color: #e0e0e0;
  }

  .card-carousel__icon {
    width: 0.75vw;
    height: 0.75vw;
  }

  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      /* Card width = height * 2/3, plus gap (1.33vw) */
      transform: translateX(calc((40vh * 2 / 3 + 1.33vw) * -31));
    }
  }

  .card-carousel:hover .card-carousel__track {
    animation-play-state: paused;
  }

  .card-carousel__overlay {
    padding-bottom: 1.11vh;
  }

  /* Large display media query removed - pure vw/vh units scale automatically */

  /* Mobile - pixel values for readability */
  @media (max-width: 768px) {
    .card-carousel__track {
      gap: 1rem;
    }

    .card-carousel__slide {
      border-radius: 12px;
    }

    .card-carousel__download {
      font-size: 12px;
      padding: 8px 16px;
      border-radius: 6px;
      gap: 4px;
    }

    .card-carousel__icon {
      width: 14px;
      height: 14px;
    }

    .card-carousel__overlay {
      padding-bottom: 1rem;
    }
  }
</style>

<script>
  // Pause carousel animation when not visible to save GPU resources
  function initCarouselOptimization() {
    const carousel = document.querySelector('[data-card-carousel]');
    if (!carousel) return;

    // Use IntersectionObserver to pause when not visible
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            carousel.classList.remove('paused');
          } else {
            carousel.classList.add('paused');
          }
        });
      },
      { threshold: 0, rootMargin: '50px' }
    );

    observer.observe(carousel);

    // Also pause when tab is not visible
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        carousel.classList.add('paused');
      } else {
        // Check if carousel is in viewport before resuming
        const rect = carousel.getBoundingClientRect();
        const inViewport = rect.top < window.innerHeight && rect.bottom > 0;
        if (inViewport) {
          carousel.classList.remove('paused');
        }
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarouselOptimization);
  } else {
    initCarouselOptimization();
  }
</script>
